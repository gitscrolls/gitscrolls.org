<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The GitScrolls - Scroll</title>
    <link rel="icon" type="image/png" href="images/gitscrolls-01-01.png">
    
    <!-- Meta descriptions and SEO -->
    <meta name="description" content="Ancient wisdom for modern developers. Read the GitScrolls and discover timeless principles of software craftsmanship.">
    <meta name="keywords" content="git, development, programming, wisdom, software engineering, best practices">
    <meta name="author" content="J. Kirby Ross">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://gitscrolls.org/scroll.html">
    <meta property="og:title" content="The GitScrolls - Ancient Wisdom">
    <meta property="og:description" content="Discover the ancient wisdom of software development through the GitScrolls.">
    <meta property="og:image" content="https://gitscrolls.org/images/gitscrolls-01-01.png">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://gitscrolls.org/scroll.html">
    <meta name="twitter:title" content="The GitScrolls - Ancient Wisdom">
    <meta name="twitter:description" content="Discover the ancient wisdom of software development through the GitScrolls.">
    <meta name="twitter:image" content="https://gitscrolls.org/images/gitscrolls-01-01.png">
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://raw.githubusercontent.com">
    <link rel="preconnect" href="https://api.github.com">
    
    <!-- DNS Prefetch for API calls -->
    <link rel="dns-prefetch" href="https://raw.githubusercontent.com">
    <link rel="dns-prefetch" href="https://api.github.com">
    
    <!-- Font loading with display swap -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/marked/marked.min.js" as="script">
    <link rel="preload" href="src/markdown/markdown-processor-browser.js" as="script">
    
    <!-- Scripts with async/defer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="src/markdown/markdown-processor-browser.js" defer></script>
    
    <!-- Umami Analytics - Replace data-website-id with your actual ID -->
    <!-- <script async defer data-website-id="YOUR-WEBSITE-ID" src="https://your-umami-instance.com/umami.js"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --parchment: #f4f1e8;
            --dark-parchment: #e8e2d0;
            --bronze: #cd7f32;
            --dark-bronze: #b8651c;
            --ancient-gold: #d4af37;
            --charcoal: #2c2c2c;
            --scroll-shadow: rgba(0, 0, 0, 0.3);
            --text-primary: #2c2c2c;
            --text-secondary: #4a4a4a;
            --bg-primary: #ffffff;
            --bg-secondary: #f4f1e8;
            --bg-header: rgba(244, 241, 232, 0.95);
            --border-color: #e8e2d0;
            --code-bg: #e8e2d0;
            --code-text: #2c2c2c;
        }

        [data-theme="dark"] {
            --parchment: #1a1a1a;
            --dark-parchment: #0d0d0d;
            --bronze: #d4af37;
            --dark-bronze: #cd7f32;
            --ancient-gold: #ffd700;
            --charcoal: #e8e2d0;
            --scroll-shadow: rgba(255, 255, 255, 0.1);
            --text-primary: #e8e2d0;
            --text-secondary: #b8b8b8;
            --bg-primary: #0d0d0d;
            --bg-secondary: #1a1a1a;
            --bg-header: rgba(26, 26, 26, 0.95);
            --border-color: #2c2c2c;
            --code-bg: #2c2c2c;
            --code-text: #e8e2d0;
        }

        /* Skip Links */
        .skip-link {
            position: absolute;
            left: -9999px;
            z-index: 9999;
            padding: 1rem;
            background: var(--bronze);
            color: white;
            text-decoration: none;
            border-radius: 0 0 8px 0;
            font-family: 'Cinzel', serif;
            font-weight: 600;
        }

        .skip-link:focus {
            left: 0;
            top: 0;
        }

        /* Focus Styles for Accessibility */
        *:focus {
            outline: 3px solid var(--bronze);
            outline-offset: 2px;
        }

        button:focus,
        a:focus {
            outline: 3px solid var(--bronze);
            outline-offset: 2px;
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .scroll-content {
                border: 2px solid var(--text-primary);
            }
            
            .nav-button,
            .dropdown-toggle,
            .share-button {
                border: 2px solid currentColor;
            }
            
            *:focus {
                outline-width: 4px;
            }
        }

        /* Screen Reader Only Text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(45deg, var(--parchment) 0%, var(--dark-parchment) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.7;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: transparent;
            border: 2px solid var(--bronze);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--bronze);
        }

        .theme-toggle:hover {
            background: var(--bronze);
            color: white;
            transform: rotate(180deg);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .theme-icon-light {
            display: block;
        }

        .theme-icon-dark {
            display: none;
        }

        [data-theme="dark"] .theme-icon-light {
            display: none;
        }

        [data-theme="dark"] .theme-icon-dark {
            display: block;
        }

        /* Header Navigation */
        .header {
            position: fixed;
            top: 0;
            width: 100%;
            background: var(--bg-header);
            backdrop-filter: blur(10px);
            border-bottom: 3px solid var(--bronze);
            z-index: 1000;
            padding: 1rem 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--bronze);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .logo:hover {
            color: var(--dark-bronze);
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            font-family: 'Cinzel', serif;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: var(--bronze);
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: transparent;
            border: 2px solid var(--bronze);
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            margin-left: auto;
            margin-right: 1rem;
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            background: var(--bronze);
        }

        .mobile-menu-toggle:hover .hamburger-line {
            background: white;
        }

        .hamburger-line {
            display: block;
            width: 24px;
            height: 2px;
            background: var(--bronze);
            margin: 4px 0;
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .mobile-menu-toggle.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-toggle.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Scroll Dropdown */
        .scroll-dropdown {
            position: relative;
            display: inline-block;
            margin-left: 2rem;
        }

        .dropdown-toggle {
            background: var(--bronze);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.3s ease;
        }

        .dropdown-toggle:hover {
            background: var(--dark-bronze);
        }

        .dropdown-arrow {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .dropdown-toggle.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-primary);
            border: 2px solid var(--bronze);
            border-radius: 8px;
            margin-top: 0.5rem;
            min-width: 250px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 8px 20px var(--scroll-shadow);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: block;
            padding: 0.8rem 1.2rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover,
        .dropdown-item:focus,
        .dropdown-item.focus {
            background: var(--bg-secondary);
            color: var(--bronze);
            padding-left: 1.5rem;
            outline: none;
        }

        .dropdown-item.current {
            background: var(--bg-secondary);
            color: var(--bronze);
            font-weight: 600;
        }

        .dropdown-item-number {
            display: inline-block;
            width: 2rem;
            font-family: 'Cinzel', serif;
            color: var(--bronze);
        }

        .dropdown-loading {
            padding: 2rem;
            text-align: center;
            color: var(--bronze);
            font-style: italic;
        }

        .dropdown-error {
            padding: 1rem;
            text-align: center;
            color: #d32f2f;
            font-size: 0.9rem;
        }

        /* Hero Section */
        .scroll-hero {
            height: 50vh;
            min-height: 400px;
            background: 
                linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.3)),
                linear-gradient(135deg, var(--bronze) 0%, var(--dark-bronze) 50%, var(--charcoal) 100%);
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-top: 80px;
            text-align: center;
            color: white;
        }

        .hero-content {
            max-width: 800px;
            padding: 2rem;
            z-index: 2;
        }

        .scroll-hero .scroll-number {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--ancient-gold);
            font-weight: 600;
            margin-bottom: 0.5rem;
            letter-spacing: 2px;
        }

        .scroll-hero .scroll-title {
            font-family: 'Cinzel', serif;
            font-size: clamp(2rem, 5vw, 3.5rem);
            color: white;
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        .scroll-subtitle {
            font-size: clamp(1rem, 2.5vw, 1.3rem);
            color: var(--ancient-gold);
            margin-bottom: 2rem;
            font-style: italic;
            opacity: 0.9;
        }

        .hero-quote {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            font-style: italic;
            color: white;
            border-left: 4px solid var(--ancient-gold);
            padding-left: 2rem;
            margin: 2rem auto 0;
            max-width: 600px;
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1.5rem 2rem;
            backdrop-filter: blur(5px);
        }

        /* Scroll Indicator */
        .scroll-indicator {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
        }

        .scroll-arrow {
            font-size: 2rem;
            color: var(--ancient-gold);
            animation: bounce 2s infinite;
            cursor: pointer;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* Poem Section */
        .poem-section {
            background: linear-gradient(to bottom, var(--bg-secondary), var(--bg-primary));
            padding: 4rem 2rem;
            border-bottom: 3px solid var(--bronze);
        }

        .poem-container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .poem-content {
            font-size: 1.2rem;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-line;
            font-style: italic;
            position: relative;
        }

        .poem-content::before,
        .poem-content::after {
            content: "❦";
            display: block;
            text-align: center;
            color: var(--bronze);
            font-size: 1.5rem;
            margin: 1rem 0;
        }

        /* Scroll Container */
        .scroll-container {
            max-width: 900px;
            margin: 0 auto 4rem;
            padding: 4rem 2rem 0;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 4rem;
            font-style: italic;
            color: var(--bronze);
        }

        /* Enhanced Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            margin: 2rem auto;
            position: relative;
        }

        .loading-spinner::before,
        .loading-spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--bronze);
            animation: spin 1.2s linear infinite;
        }

        .loading-spinner::after {
            border-top-color: var(--ancient-gold);
            animation-delay: 0.4s;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--bronze);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Skeleton Loading for Cards */
        .skeleton-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px var(--scroll-shadow);
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }

        .skeleton-line {
            height: 1rem;
            background: linear-gradient(90deg, 
                var(--bg-secondary) 25%, 
                var(--border-color) 50%, 
                var(--bg-secondary) 75%);
            background-size: 200% 100%;
            border-radius: 4px;
            margin-bottom: 0.8rem;
            animation: skeleton-wave 1.5s ease-in-out infinite;
        }

        .skeleton-line.short { width: 40%; }
        .skeleton-line.medium { width: 70%; }
        .skeleton-line.long { width: 90%; }

        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes skeleton-wave {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .error {
            text-align: center;
            padding: 4rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 8px;
            margin: 2rem 0;
        }

        /* Scroll Content Styles */
        .scroll-content {
            background: var(--bg-primary);
            padding: 4rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--scroll-shadow);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .scroll-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(205, 127, 50, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(232, 226, 208, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .scroll-content > * {
            position: relative;
            z-index: 1;
        }

        /* Markdown Content Styling */
        .scroll-content h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--bronze);
            margin: 3rem 0 1.5rem;
            font-weight: 700;
        }

        .scroll-content h2 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--dark-bronze);
            margin: 2.5rem 0 1rem;
            font-weight: 600;
        }

        .scroll-content h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--text-primary);
            margin: 2rem 0 1rem;
            font-weight: 600;
        }

        .scroll-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        .scroll-content blockquote {
            border-left: 4px solid var(--bronze);
            padding-left: 2rem;
            margin: 2rem 0;
            font-style: italic;
            color: var(--dark-bronze);
            font-size: 1.2rem;
        }

        .scroll-content code {
            background: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: var(--code-text);
        }

        .scroll-content pre {
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        .scroll-content pre code {
            background: none;
            padding: 0;
            color: var(--bg-primary);
        }

        .scroll-content em {
            font-style: italic;
            color: var(--dark-bronze);
        }

        .scroll-content strong {
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Navigation */
        .scroll-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 4rem;
            padding: 2rem 0;
            border-top: 2px solid var(--bronze);
        }

        .nav-button {
            display: inline-block;
            padding: 1rem 2rem;
            background: var(--bronze);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            background: var(--dark-bronze);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(205, 127, 50, 0.3);
        }

        .nav-button.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Breadcrumb Navigation */
        .breadcrumb-nav {
            position: sticky;
            top: 80px;
            background: var(--bg-header);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--bronze);
            z-index: 900;
            padding: 0.75rem 0;
            display: none;
        }

        .breadcrumb-nav.visible {
            display: block;
        }

        .breadcrumb-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .breadcrumb-path {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .breadcrumb-separator {
            color: var(--bronze);
        }

        .breadcrumb-current {
            font-weight: 600;
            color: var(--bronze);
        }

        /* TOC Dropdown */
        .toc-dropdown {
            position: relative;
        }

        .toc-toggle {
            background: transparent;
            border: 2px solid var(--bronze);
            color: var(--bronze);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .toc-toggle:hover {
            background: var(--bronze);
            color: white;
        }

        .toc-toggle.active {
            background: var(--bronze);
            color: white;
        }

        .toc-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-primary);
            border: 2px solid var(--bronze);
            border-radius: 8px;
            margin-top: 0.5rem;
            min-width: 300px;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 8px 20px var(--scroll-shadow);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .toc-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .toc-item {
            display: block;
            padding: 0.6rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .toc-item:last-child {
            border-bottom: none;
        }

        .toc-item:hover {
            background: var(--bg-secondary);
            color: var(--bronze);
            padding-left: 1.3rem;
        }

        .toc-item.active {
            background: var(--bg-secondary);
            color: var(--bronze);
            font-weight: 600;
        }

        .toc-item-h2 {
            padding-left: 1.5rem;
        }

        .toc-item-h3 {
            padding-left: 2.5rem;
            font-size: 0.85rem;
        }

        /* Reading Progress Bar */
        .reading-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--ancient-gold);
            transition: width 0.1s ease;
            width: 0%;
        }

        /* Reading Time Indicator */
        .reading-time {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--bronze);
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .reading-time svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* Position Saved Toast */
        .position-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bronze);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            box-shadow: 0 4px 12px var(--scroll-shadow);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .position-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Bookmarks and Highlights */
        .bookmark-button {
            position: fixed;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-primary);
            border: 2px solid var(--bronze);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--scroll-shadow);
            transition: all 0.3s ease;
            z-index: 500;
            color: var(--bronze);
        }

        .bookmark-button:hover {
            background: var(--bronze);
            color: white;
            transform: translateY(-50%) scale(1.1);
        }

        .bookmark-button.active {
            background: var(--bronze);
            color: white;
        }

        .bookmark-button svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .bookmarks-panel {
            position: fixed;
            right: -400px;
            top: 80px;
            bottom: 0;
            width: 350px;
            background: var(--bg-primary);
            border-left: 3px solid var(--bronze);
            box-shadow: -4px 0 20px var(--scroll-shadow);
            transition: right 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            padding: 2rem;
        }

        .bookmarks-panel.show {
            right: 0;
        }

        .bookmarks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .bookmarks-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--bronze);
            margin: 0;
        }

        .close-bookmarks {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--bronze);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .close-bookmarks:hover {
            transform: scale(1.2);
        }

        .bookmark-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid var(--bronze);
        }

        .bookmark-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px var(--scroll-shadow);
        }

        .bookmark-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .bookmark-excerpt {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .bookmark-date {
            font-size: 0.8rem;
            color: var(--bronze);
            margin-top: 0.5rem;
        }

        .delete-bookmark {
            float: right;
            background: none;
            border: none;
            color: var(--bronze);
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .delete-bookmark:hover {
            opacity: 1;
        }

        /* Text Highlighting */
        .text-highlight {
            background: rgba(212, 175, 55, 0.3);
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .text-highlight:hover {
            background: rgba(212, 175, 55, 0.5);
        }

        [data-theme="dark"] .text-highlight {
            background: rgba(212, 175, 55, 0.4);
        }

        [data-theme="dark"] .text-highlight:hover {
            background: rgba(212, 175, 55, 0.6);
        }

        .highlight-tooltip {
            position: absolute;
            background: var(--bg-primary);
            border: 2px solid var(--bronze);
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: 0 4px 12px var(--scroll-shadow);
            z-index: 1000;
            display: none;
        }

        .highlight-tooltip button {
            background: var(--bronze);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .highlight-tooltip button:hover {
            background: var(--dark-bronze);
        }

        @media (max-width: 768px) {
            .bookmark-button {
                right: 1rem;
                width: 40px;
                height: 40px;
            }
            
            .bookmarks-panel {
                width: 100%;
                right: -100%;
            }
        }

        /* Section Dividers */
        .section-divider {
            text-align: center;
            margin: 4rem 0;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        .section-divider.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .divider-image {
            max-width: 200px;
            height: auto;
            filter: sepia(100%) saturate(50%) hue-rotate(15deg) opacity(0.7);
        }

        .divider-ornament {
            font-size: 2rem;
            color: var(--bronze);
            margin: 3rem 0;
            text-align: center;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.6s ease;
        }

        .divider-ornament.visible {
            opacity: 1;
            transform: scale(1);
        }

        /* Lazy Loading */
        img.lazy {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        img.lazy.loaded {
            opacity: 1;
        }

        /* Social Sharing */
        .social-sharing {
            margin: 4rem 0 2rem;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px solid var(--bronze);
            text-align: center;
        }

        .social-sharing h3 {
            font-family: 'Cinzel', serif;
            color: var(--bronze);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .share-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.5rem;
            background: var(--bronze);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid var(--bronze);
        }

        .share-button:hover {
            background: var(--bg-primary);
            color: var(--bronze);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--scroll-shadow);
        }

        .share-button svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Infinite Scroll Toggle */
        .infinite-scroll-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bronze);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 0.8rem 1.5rem;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--scroll-shadow);
            transition: all 0.3s ease;
            z-index: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .infinite-scroll-toggle:hover {
            background: var(--dark-bronze);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--scroll-shadow);
        }

        .infinite-scroll-toggle.active {
            background: var(--ancient-gold);
            color: var(--text-primary);
        }

        .infinite-scroll-toggle svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Infinite Scroll Mode */
        body.infinite-mode .scroll-nav,
        body.infinite-mode .social-sharing,
        body.infinite-mode .footer {
            display: none !important;
        }

        body.infinite-mode .scroll-container {
            /* Keep the same max-width as normal mode */
            max-width: 900px;
            margin: 0 auto;
        }

        body.infinite-mode .scroll-content {
            margin-bottom: 2rem;
        }

        /* Infinite scroll sections */
        .infinite-section {
            min-height: 100vh;
            opacity: 1;
            transform: translateY(0);
            transition: all 0.6s ease;
        }

        .infinite-section.loading {
            opacity: 0.3;
            transform: translateY(20px);
        }

        .infinite-section.removing {
            opacity: 0;
            transform: translateY(-20px);
        }

        /* Infinite Scroll Container */
        .infinite-scroll-container {
            min-height: 100vh;
        }

        .scroll-section {
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .scroll-section.loading {
            opacity: 0.5;
        }

        .scroll-divider {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--bronze);
            position: relative;
            margin: 4rem 0;
        }

        .scroll-divider::before,
        .scroll-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 2px;
            background: var(--bronze);
        }

        .scroll-divider::before {
            left: 0;
        }

        .scroll-divider::after {
            right: 0;
        }

        /* Footer */
        .footer {
            background: var(--bg-secondary);
            padding: 2rem;
            text-align: center;
            border-top: 3px solid var(--bronze);
            margin-top: 4rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .scroll-dropdown {
                margin-left: 1rem;
                margin-right: 1rem;
            }
            
            .dropdown-toggle {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }
            
            .dropdown-menu {
                min-width: 200px;
                max-width: calc(100vw - 4rem);
                right: 0;
                left: auto;
            }
            
            .dropdown-item {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            
            .scroll-hero {
                height: 60vh;
                min-height: 350px;
            }
            
            .hero-content {
                padding: 1rem;
            }
            
            .hero-quote {
                padding: 1rem;
                text-align: center;
                border-left: none;
                border-top: 3px solid var(--ancient-gold);
            }
            
            .poem-section {
                padding: 2rem 1rem;
            }
            
            .scroll-container {
                padding: 2rem 1rem 0;
            }
            
            .scroll-content {
                padding: 2rem 1rem;
            }
            
            .mobile-menu-toggle {
                display: block;
            }

            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--bg-header);
                backdrop-filter: blur(10px);
                flex-direction: column;
                padding: 1rem 0;
                border-bottom: 3px solid var(--bronze);
                box-shadow: 0 4px 12px var(--scroll-shadow);
                z-index: 998;
            }

            .nav-links.active {
                display: flex;
            }

            .nav-links li {
                width: 100%;
                text-align: center;
            }

            .nav-links a {
                display: block;
                padding: 1rem 2rem;
                border-bottom: 1px solid var(--border-color);
            }

            .nav-links a:hover {
                background: var(--bg-secondary);
            }
            
            .theme-toggle {
                margin-left: 0;
            }
            
            .breadcrumb-nav {
                top: 70px;
                padding: 0.5rem 0;
            }
            
            .breadcrumb-container {
                padding: 0 1rem;
            }
            
            .breadcrumb-path {
                font-size: 0.8rem;
            }
            
            .toc-toggle {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
            
            .toc-menu {
                min-width: 250px;
                max-width: calc(100vw - 2rem);
            }
        }

        /* Print Styles */
        @media print {
            /* Hide navigation and interactive elements */
            .header,
            .breadcrumb-nav,
            .scroll-dropdown,
            .nav-links,
            .scroll-nav,
            .social-sharing,
            .scroll-indicator,
            .toc-dropdown,
            .footer {
                display: none !important;
            }

            /* Adjust hero for print */
            .scroll-hero {
                height: auto;
                min-height: auto;
                background: none !important;
                color: black;
                page-break-after: always;
                margin-top: 0;
                padding: 2rem 0;
            }

            .hero-content {
                max-width: 100%;
            }

            .scroll-hero .scroll-title,
            .scroll-hero .scroll-number,
            .hero-quote {
                color: black !important;
                text-shadow: none !important;
            }

            .hero-quote {
                background: none !important;
                border-left: 4px solid black;
                padding: 1rem 0 1rem 2rem;
            }

            /* Poem section */
            .poem-section {
                page-break-after: always;
                background: none;
                border: none;
            }

            /* Content adjustments */
            .scroll-container {
                max-width: 100%;
                margin: 0;
                padding: 0;
            }

            .scroll-content {
                box-shadow: none;
                border: none;
                padding: 2rem 0;
                background: white;
            }

            /* Typography for print */
            body {
                font-size: 12pt;
                line-height: 1.5;
                color: black;
                background: white;
            }

            h1, h2, h3 {
                page-break-after: avoid;
                color: black;
            }

            p, blockquote {
                orphans: 3;
                widows: 3;
            }

            blockquote {
                border-left-color: black;
                color: black;
            }

            /* Images */
            .section-divider,
            .divider-ornament {
                display: none;
            }

            img {
                max-width: 100%;
                page-break-inside: avoid;
            }

            /* Code blocks */
            pre {
                background: #f5f5f5;
                color: black;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }

            code {
                background: #f5f5f5;
                color: black;
            }

            /* Links */
            a {
                color: black;
                text-decoration: underline;
            }

            /* Add URL after links in print */
            a[href^="http"]:after {
                content: " (" attr(href) ")";
                font-size: 0.8em;
                color: #666;
            }

            /* Page numbers */
            @page {
                margin: 1in;
                @bottom-center {
                    content: counter(page);
                }
            }
        }
    </style>
</head>
<body>
    <!-- Skip Navigation Links -->
    <a href="#scrollContent" class="skip-link">Skip to main content</a>
    <a href="#scrollNav" class="skip-link">Skip to navigation</a>

    <!-- Header -->
    <header class="header" role="banner">
        <nav class="nav-container" role="navigation" aria-label="Main navigation">
            <a href="index.html" class="logo">THE GITSCROLLS</a>
            <div class="scroll-dropdown">
                <button class="dropdown-toggle" id="dropdownToggle" aria-label="Select a scroll to read" aria-expanded="false" aria-controls="dropdownMenu">
                    <span id="currentScrollLabel">Select Scroll</span>
                    <span class="dropdown-arrow" aria-hidden="true">▼</span>
                </button>
                <div class="dropdown-menu" id="dropdownMenu" role="menu" aria-labelledby="dropdownToggle">
                    <div class="dropdown-loading" role="status" aria-live="polite">
                        <div class="loading-spinner" style="width: 30px; height: 30px; margin: 1rem auto;"></div>
                        <div style="font-size: 0.9rem; color: var(--bronze);">Loading scrolls...</div>
                    </div>
                </div>
            </div>
            <ul class="nav-links" role="list">
                <li><a href="index.html#scrolls">The Scrolls</a></li>
                <li><a href="index.html#community">Community</a></li>
                <li><a href="https://github.com/gitscrolls/gitscrolls" rel="external">GitHub</a></li>
            </ul>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode" aria-pressed="false">
                <svg class="theme-icon-light" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                </svg>
                <svg class="theme-icon-dark" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.88-.1-1.36-.1z"/>
                </svg>
            </button>
        </nav>
    </header>

    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav" id="breadcrumbNav">
        <div class="breadcrumb-container">
            <div class="breadcrumb-path">
                <a href="index.html">Home</a>
                <span class="breadcrumb-separator">›</span>
                <span class="breadcrumb-current" id="currentSection">Introduction</span>
            </div>
            <div class="reading-time" id="readingTime" style="display: none;">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
                </svg>
                <span id="readingTimeText">5 min read</span>
            </div>
            <div class="toc-dropdown">
                <button class="toc-toggle" id="tocToggle" aria-label="Table of contents" aria-expanded="false" aria-controls="tocMenu">
                    <span>Contents</span>
                    <span class="dropdown-arrow" aria-hidden="true">▼</span>
                </button>
                <nav class="toc-menu" id="tocMenu" role="navigation" aria-label="Table of contents" aria-labelledby="tocToggle"></nav>
            </div>
        </div>
        <div class="reading-progress" id="readingProgress"></div>
    </nav>

    <!-- Hero Section -->
    <section class="scroll-hero" id="scrollHero">
        <div class="hero-content">
            <div class="scroll-number" id="scrollNumber">SCROLL</div>
            <h1 class="scroll-title" id="scrollTitle">Loading...</h1>
            <div class="scroll-subtitle" id="scrollSubtitle"></div>
            <blockquote class="hero-quote" id="heroQuote">
                Unfurling the ancient wisdom...
            </blockquote>
        </div>
        <div class="scroll-indicator">
            <div class="scroll-arrow">↓</div>
        </div>
    </section>

    <!-- Poem Section -->
    <section class="poem-section" id="poemSection" style="display: none;">
        <div class="poem-container">
            <div class="poem-content" id="poemContent"></div>
        </div>
    </section>

    <!-- Content Container -->
    <main class="scroll-container" role="main">
        <div id="scrollContent" class="loading" role="status" aria-live="polite" aria-busy="true">
            <span class="sr-only">Loading scroll content</span>
            <div class="loading-spinner"></div>
            <div class="loading-text">Unfurling the sacred text...</div>
        </div>

        <nav class="scroll-nav" id="scrollNav" style="display: none;" role="navigation" aria-label="Scroll navigation">
            <a href="#" class="nav-button" id="prevScroll" rel="prev">← Previous Scroll</a>
            <a href="#" class="nav-button" id="nextScroll" rel="next">Next Scroll →</a>
        </nav>
    </main>

    <!-- Footer -->
    <footer class="footer" role="contentinfo">
        <p>"Stop reading. Start helping. The circle is not complete. Your turn is here."</p>
        <p>
            <strong>Copyleft © 2025 J. Kirby Ross, Scrollkeeper</strong><br>
            Shared freely under the Sacred Commit Covenant (<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>)<br>
            <a href="https://github.com/gitscrolls/gitscrolls/blob/main/LICENSE">LICENSE</a> 🔗 · 
            <a href="https://github.com/gitscrolls/gitscrolls/blob/main/LICENSE_USAGE.md">Usage Rites</a> 📜
        </p>
    </footer>

    <!-- Infinite Scroll Toggle -->
    <button class="infinite-scroll-toggle" id="infiniteScrollToggle" aria-label="Toggle infinite scroll mode">
        <svg viewBox="0 0 24 24">
            <path d="M12 2C13.0609 2 14.0783 2.42143 14.8284 3.17157C15.5786 3.92172 16 4.93913 16 6C16 7.06087 15.5786 8.07828 14.8284 8.82843C14.0783 9.57857 13.0609 10 12 10C10.9391 10 9.92172 9.57857 9.17157 8.82843C8.42143 8.07828 8 7.06087 8 6C8 4.93913 8.42143 3.92172 9.17157 3.17157C9.92172 2.42143 10.9391 2 12 2ZM12 14C13.0609 14 14.0783 14.4214 14.8284 15.1716C15.5786 15.9217 16 16.9391 16 18C16 19.0609 15.5786 20.0783 14.8284 20.8284C14.0783 21.5786 13.0609 22 12 22C10.9391 22 9.92172 21.5786 9.17157 20.8284C8.42143 20.0783 8 19.0609 8 18C8 16.9391 8.42143 15.9217 9.17157 15.1716C9.92172 14.4214 10.9391 14 12 14Z"/>
        </svg>
        <span>Infinite Scroll</span>
    </button>

    <!-- Position Saved Toast -->
    <div class="position-toast" id="positionToast">
        Reading position saved
    </div>

    <!-- Bookmark Button -->
    <button class="bookmark-button" id="bookmarkButton" aria-label="View bookmarks">
        <svg viewBox="0 0 24 24">
            <path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
        </svg>
    </button>

    <!-- Bookmarks Panel -->
    <div class="bookmarks-panel" id="bookmarksPanel">
        <div class="bookmarks-header">
            <h2>Bookmarks & Highlights</h2>
            <button class="close-bookmarks" id="closeBookmarks" aria-label="Close bookmarks">×</button>
        </div>
        <div id="bookmarksList">
            <!-- Bookmarks will be added here -->
        </div>
    </div>

    <!-- Highlight Tooltip -->
    <div class="highlight-tooltip" id="highlightTooltip">
        <button onclick="saveHighlight()">Highlight</button>
    </div>

    <script>
        // Scroll metadata
        const scrolls = [
            { number: 1, file: '01-Unbroken-Line.md', title: 'The Unbroken Line' },
            { number: 2, file: '02-Chronicle-Forgotten-Messages.md', title: 'Chronicle of Forgotten Messages' },
            { number: 3, file: '03-Oracle-Testament.md', title: 'Oracle\'s Testament of Devotion' },
            { number: 4, file: '04-Schism-Scrolls.md', title: 'The Schism Scrolls' },
            { number: 5, file: '05-Wounding-Hubris.md', title: 'The Wounding of Hubris' },
            { number: 6, file: '06-Songs-Chaos-Sirens.md', title: 'Songs of the Chaos Sirens' },
            { number: 7, file: '07-Between-Monsters-Time.md', title: 'Between the Monsters of Time' },
            { number: 8, file: '08-Ancient-Reviewer.md', title: 'Before the Ancient Reviewer' },
            { number: 9, file: '09-Commandments-Wise.md', title: 'Commandments of the Wise' },
            { number: 10, file: '10-Where-Heroes-Die.md', title: 'Where Heroes Go to Die' }
        ];

        // Get scroll number from URL
        const urlParams = new URLSearchParams(window.location.search);
        const scrollNum = parseInt(urlParams.get('scroll')) || 1;
        const currentScroll = scrolls.find(s => s.number === scrollNum) || scrolls[0];

        // Update header
        document.getElementById('scrollNumber').textContent = `SCROLL ${currentScroll.number < 10 ? 'I'.repeat(currentScroll.number) : 'X'}`;
        document.getElementById('scrollTitle').textContent = currentScroll.title;
        document.title = `The GitScrolls - ${currentScroll.title}`;
        
        // Update meta tags
        updateMetaTags();

        // Fetch and render markdown
        async function loadScroll() {
            const contentDiv = document.getElementById('scrollContent');
            const navDiv = document.getElementById('scrollNav');
            
            try {
                const response = await fetch(`https://raw.githubusercontent.com/gitscrolls/gitscrolls/refs/heads/main/scrolls/${currentScroll.file}`);
                if (!response.ok) throw new Error('Failed to fetch scroll');
                
                const rawMarkdown = await response.text();
                
                // Process the markdown
                const processor = new MarkdownProcessor();
                const processed = processor.process(rawMarkdown);
                
                // Build hero image path from scroll number
                const heroImages = {
                    3: 'images/scroll-03-hero.png',
                    4: 'images/scroll-04-hero.png',
                    13: 'images/scroll-13-hero.png',
                    15: 'images/scroll-15-hero.png'
                };
                
                // Use specific hero image if available, otherwise use a default pattern
                const heroImagePath = heroImages[scrollNum] || `images/scroll-${String(scrollNum).padStart(2, '0')}-01.png`;
                
                // Update hero section
                updateHeroSection(processed, heroImagePath);
                
                // Update poem section
                updatePoemSection(processed.poem);
                
                // Render main content
                const html = marked.parse(processed.content);
                contentDiv.className = 'scroll-content';
                contentDiv.innerHTML = html;
                contentDiv.removeAttribute('aria-busy');
                contentDiv.removeAttribute('role');
                
                // Add social sharing section
                addSocialSharing();
                
                // Log what we extracted for debugging
                console.log('Extracted components:', {
                    title: processed.title,
                    subtitle: processed.subtitle,
                    quote: processed.quote,
                    poem: processed.poem,
                    heroImagePath: heroImagePath
                });
                
                // Setup navigation
                setupNavigation();
                navDiv.style.display = 'flex';
                
                // Smooth scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
            } catch (error) {
                contentDiv.className = 'error';
                contentDiv.innerHTML = `
                    <h2>The scroll could not be retrieved</h2>
                    <p>${error.message}</p>
                    <p>Perhaps the ancient servers are resting...</p>
                `;
            }
        }

        function updateHeroSection(processed, heroImagePath) {
            // Update hero background image
            const heroSection = document.getElementById('scrollHero');
            
            // Try to load the image first
            const img = new Image();
            img.onload = function() {
                // Image loaded successfully, use it
                heroSection.style.backgroundImage = `
                    linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.3)),
                    url('${heroImagePath}')
                `;
            };
            img.onerror = function() {
                // Image failed to load, use a fallback gradient
                heroSection.style.background = `
                    linear-gradient(135deg, var(--bronze) 0%, var(--dark-bronze) 50%, var(--charcoal) 100%)
                `;
            };
            img.src = heroImagePath;
            
            // Update content
            if (processed.title) {
                document.getElementById('scrollTitle').textContent = processed.title;
            }
            
            if (processed.subtitle) {
                document.getElementById('scrollSubtitle').textContent = processed.subtitle;
            }
            
            if (processed.quote) {
                document.getElementById('heroQuote').textContent = `"${processed.quote}"`;
            }
        }

        function updatePoemSection(poem) {
            const poemSection = document.getElementById('poemSection');
            const poemContent = document.getElementById('poemContent');
            
            if (poem && poem.trim()) {
                poemContent.textContent = poem;
                poemSection.style.display = 'block';
            } else {
                poemSection.style.display = 'none';
            }
        }

        function setupNavigation() {
            const prevBtn = document.getElementById('prevScroll');
            const nextBtn = document.getElementById('nextScroll');
            
            if (scrollNum > 1) {
                prevBtn.href = `scroll.html?scroll=${scrollNum - 1}`;
                prevBtn.classList.remove('disabled');
                // Prefetch previous scroll
                prefetchScroll(scrollNum - 1);
            } else {
                prevBtn.classList.add('disabled');
            }
            
            if (scrollNum < 10) {
                nextBtn.href = `scroll.html?scroll=${scrollNum + 1}`;
                nextBtn.classList.remove('disabled');
                // Prefetch next scroll
                prefetchScroll(scrollNum + 1);
            } else {
                nextBtn.classList.add('disabled');
            }
        }

        // Prefetch adjacent scrolls for faster navigation
        function prefetchScroll(num) {
            if (num < 1 || num > 10) return;
            
            const scroll = scrolls[num - 1];
            if (!scroll) return;
            
            // Prefetch the markdown content
            const url = `https://raw.githubusercontent.com/gitscrolls/gitscrolls/refs/heads/main/scrolls/${scroll.file}`;
            
            // Use link prefetch
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = url;
            link.as = 'fetch';
            link.crossOrigin = 'anonymous';
            document.head.appendChild(link);
            
            // Also add to cache if service worker is available
            if ('caches' in window) {
                caches.open('gitscrolls-v1').then(cache => {
                    fetch(url).then(response => {
                        if (response.ok) {
                            cache.put(url, response.clone());
                        }
                    }).catch(() => {
                        // Silently fail if prefetch fails
                    });
                });
            }
        }

        // Add scroll indicator functionality
        document.querySelector('.scroll-arrow').addEventListener('click', () => {
            const poemSection = document.getElementById('poemSection');
            const scrollContainer = document.querySelector('.scroll-container');
            const target = poemSection.style.display !== 'none' ? poemSection : scrollContainer;
            
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            target.scrollIntoView({
                behavior: prefersReducedMotion ? 'auto' : 'smooth',
                block: 'start'
            });
        });

        // Load the scroll
        loadScroll();

        // Dropdown functionality
        const dropdownToggle = document.getElementById('dropdownToggle');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const currentScrollLabel = document.getElementById('currentScrollLabel');

        // Update current scroll label
        currentScrollLabel.textContent = `Scroll ${scrollNum}: ${currentScroll.title}`;

        // Toggle dropdown
        dropdownToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = dropdownMenu.classList.contains('show');
            
            if (!isOpen) {
                dropdownToggle.classList.add('active');
                dropdownMenu.classList.add('show');
                dropdownToggle.setAttribute('aria-expanded', 'true');
                loadScrollList();
            } else {
                closeDropdown();
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            closeDropdown();
        });

        // Prevent closing when clicking inside dropdown
        dropdownMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        function closeDropdown() {
            dropdownToggle.classList.remove('active');
            dropdownMenu.classList.remove('show');
            dropdownToggle.setAttribute('aria-expanded', 'false');
        }

        // Load scroll list from GitHub API with caching
        async function loadScrollList() {
            const cacheKey = 'gitscrolls-list';
            const cacheExpiry = 'gitscrolls-list-expiry';
            const now = Date.now();
            
            // Check cache
            const cachedData = localStorage.getItem(cacheKey);
            const cachedExpiry = localStorage.getItem(cacheExpiry);
            
            if (cachedData && cachedExpiry && now < parseInt(cachedExpiry)) {
                displayScrollList(JSON.parse(cachedData));
                return;
            }
            
            try {
                const response = await fetch('https://api.github.com/repos/gitscrolls/gitscrolls/contents/scrolls');
                if (!response.ok) throw new Error('Failed to fetch scroll list');
                
                const files = await response.json();
                const scrollFiles = files
                    .filter(file => file.name.endsWith('.md'))
                    .sort((a, b) => a.name.localeCompare(b.name));
                
                // Cache for 1 hour
                localStorage.setItem(cacheKey, JSON.stringify(scrollFiles));
                localStorage.setItem(cacheExpiry, (now + 3600000).toString());
                
                displayScrollList(scrollFiles);
            } catch (error) {
                dropdownMenu.innerHTML = `
                    <div class="dropdown-error">
                        Failed to load scrolls.<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        function displayScrollList(scrollFiles) {
            dropdownMenu.innerHTML = '';
            
            scrollFiles.forEach((file, index) => {
                const scrollNumber = index + 1;
                const scrollInfo = scrolls.find(s => s.file === file.name);
                const title = scrollInfo ? scrollInfo.title : file.name.replace('.md', '');
                
                const item = document.createElement('a');
                item.href = `scroll.html?scroll=${scrollNumber}`;
                item.className = 'dropdown-item';
                if (scrollNumber === scrollNum) {
                    item.classList.add('current');
                }
                
                item.innerHTML = `
                    <span class="dropdown-item-number">${scrollNumber}.</span>
                    ${title}
                `;
                
                dropdownMenu.appendChild(item);
            });
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!dropdownMenu.classList.contains('show')) return;
            
            const items = dropdownMenu.querySelectorAll('.dropdown-item');
            const currentIndex = Array.from(items).findIndex(item => item.classList.contains('focus'));
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (currentIndex < items.length - 1) {
                        items[currentIndex]?.classList.remove('focus');
                        items[currentIndex + 1].classList.add('focus');
                        items[currentIndex + 1].focus();
                    } else if (currentIndex === -1 && items.length > 0) {
                        items[0].classList.add('focus');
                        items[0].focus();
                    }
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    if (currentIndex > 0) {
                        items[currentIndex].classList.remove('focus');
                        items[currentIndex - 1].classList.add('focus');
                        items[currentIndex - 1].focus();
                    }
                    break;
                    
                case 'Escape':
                    closeDropdown();
                    dropdownToggle.focus();
                    break;
            }
        });

        // Breadcrumb Navigation and TOC
        const breadcrumbNav = document.getElementById('breadcrumbNav');
        const tocToggle = document.getElementById('tocToggle');
        const tocMenu = document.getElementById('tocMenu');
        const currentSection = document.getElementById('currentSection');
        const readingProgress = document.getElementById('readingProgress');
        let headings = [];
        let currentActiveSection = null;

        // Generate TOC after content loads
        function generateTOC() {
            const contentDiv = document.getElementById('scrollContent');
            if (!contentDiv.classList.contains('scroll-content')) return;

            // Get all headings
            const allHeadings = contentDiv.querySelectorAll('h1, h2, h3');
            headings = Array.from(allHeadings).map((heading, index) => {
                // Add ID to heading for anchoring
                const id = `section-${index}`;
                heading.id = id;
                
                return {
                    element: heading,
                    id: id,
                    text: heading.textContent,
                    level: heading.tagName.toLowerCase(),
                    top: 0 // Will be updated on scroll
                };
            });

            // Build TOC menu
            tocMenu.innerHTML = '';
            headings.forEach(heading => {
                const item = document.createElement('a');
                item.href = `#${heading.id}`;
                item.className = `toc-item toc-item-${heading.level}`;
                item.textContent = heading.text;
                
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    smoothScrollToSection(heading.id);
                    closeTOC();
                });
                
                tocMenu.appendChild(item);
            });

            // Show breadcrumb nav once content is loaded
            if (headings.length > 0) {
                breadcrumbNav.classList.add('visible');
                updateSectionPositions();
                updateActiveSection();
            }
        }

        // Smooth scroll to section
        function smoothScrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                const offset = breadcrumbNav.offsetHeight + document.querySelector('.header').offsetHeight + 20;
                const top = element.offsetTop - offset;
                window.scrollTo({
                    top: top,
                    behavior: 'smooth'
                });
            }
        }

        // Update section positions
        function updateSectionPositions() {
            headings.forEach(heading => {
                heading.top = heading.element.offsetTop;
            });
        }

        // Update active section based on scroll
        function updateActiveSection() {
            const scrollTop = window.scrollY;
            const offset = breadcrumbNav.offsetHeight + document.querySelector('.header').offsetHeight + 50;
            
            // Find current section
            let current = headings[0];
            for (let i = headings.length - 1; i >= 0; i--) {
                if (scrollTop + offset >= headings[i].top) {
                    current = headings[i];
                    break;
                }
            }
            
            if (current && current.id !== currentActiveSection) {
                currentActiveSection = current.id;
                
                // Update breadcrumb
                currentSection.textContent = current.text;
                
                // Update TOC active state
                tocMenu.querySelectorAll('.toc-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.href.endsWith(`#${current.id}`)) {
                        item.classList.add('active');
                    }
                });
            }
            
            // Update reading progress
            const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const progress = (scrollTop / docHeight) * 100;
            readingProgress.style.width = `${progress}%`;
        }

        // TOC dropdown functionality
        tocToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = tocMenu.classList.contains('show');
            
            if (!isOpen) {
                tocToggle.classList.add('active');
                tocMenu.classList.add('show');
                tocToggle.setAttribute('aria-expanded', 'true');
            } else {
                closeTOC();
            }
        });

        function closeTOC() {
            tocToggle.classList.remove('active');
            tocMenu.classList.remove('show');
            tocToggle.setAttribute('aria-expanded', 'false');
        }

        // Close TOC when clicking outside
        document.addEventListener('click', () => {
            closeTOC();
        });

        // Prevent closing when clicking inside TOC
        tocMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Scroll event handlers
        let tocScrollTimeout;
        window.addEventListener('scroll', () => {
            if (headings.length > 0) {
                updateActiveSection();
                
                // Debounce position updates
                clearTimeout(tocScrollTimeout);
                tocScrollTimeout = setTimeout(updateSectionPositions, 100);
            }
            
            // Handle position saving
            handlePositionSaving();
        });

        // Window resize handler
        window.addEventListener('resize', () => {
            if (headings.length > 0) {
                updateSectionPositions();
            }
        });

        // Reading Time Calculation
        function calculateReadingTime() {
            const contentDiv = document.getElementById('scrollContent');
            if (!contentDiv.classList.contains('scroll-content')) return;
            
            // Get text content
            const text = contentDiv.textContent || '';
            const wordCount = text.trim().split(/\s+/).length;
            
            // Average reading speed: 200 words per minute
            const readingTime = Math.ceil(wordCount / 200);
            
            // Update UI
            const readingTimeEl = document.getElementById('readingTime');
            const readingTimeText = document.getElementById('readingTimeText');
            
            if (readingTimeEl && readingTimeText) {
                readingTimeText.textContent = `${readingTime} min read`;
                readingTimeEl.style.display = 'flex';
            }
            
            return readingTime;
        }

        // Position Saving and Restoration
        const POSITION_KEY = `gitscrolls-position-${scrollNum}`;
        let savePositionTimeout;
        
        function saveReadingPosition() {
            const scrollTop = window.scrollY;
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;
            const scrollPercent = (scrollTop / (scrollHeight - clientHeight)) * 100;
            
            const positionData = {
                scrollTop: scrollTop,
                scrollPercent: scrollPercent,
                timestamp: Date.now(),
                scrollNumber: scrollNum,
                sectionId: currentActiveSection
            };
            
            localStorage.setItem(POSITION_KEY, JSON.stringify(positionData));
            
            // Show toast
            showPositionToast();
        }
        
        function restoreReadingPosition() {
            const savedPosition = localStorage.getItem(POSITION_KEY);
            if (!savedPosition) return false;
            
            try {
                const position = JSON.parse(savedPosition);
                
                // Only restore if saved within last 7 days
                const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                if (position.timestamp < sevenDaysAgo) {
                    localStorage.removeItem(POSITION_KEY);
                    return false;
                }
                
                // Wait for content to load then scroll
                setTimeout(() => {
                    window.scrollTo({
                        top: position.scrollTop,
                        behavior: 'smooth'
                    });
                    
                    // Track position restoration
                    trackEvent('position_restored', {
                        scroll_number: scrollNum,
                        percent: Math.round(position.scrollPercent)
                    });
                }, 500);
                
                return true;
            } catch (e) {
                return false;
            }
        }
        
        function showPositionToast(message = 'Reading position saved') {
            const toast = document.getElementById('positionToast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        
        // Auto-save position on scroll (added to existing scroll handler)
        function handlePositionSaving() {
            if (!infiniteScrollMode) { // Only save in normal mode
                clearTimeout(savePositionTimeout);
                savePositionTimeout = setTimeout(saveReadingPosition, 1000);
            }
        }

        // Call generateTOC and reading time after content loads
        const originalLoadScroll = loadScroll;
        loadScroll = async function() {
            await originalLoadScroll();
            setTimeout(() => {
                generateTOC();
                addSectionDividers();
                setupLazyLoading();
                calculateReadingTime();
                
                // Restore position if available
                const restored = restoreReadingPosition();
                if (restored) {
                    showPositionToast('Position restored');
                }
            }, 100); // Small delay to ensure DOM is ready
        };

        // Add decorative dividers between sections
        function addSectionDividers() {
            const contentDiv = document.getElementById('scrollContent');
            if (!contentDiv.classList.contains('scroll-content')) return;

            const h2Elements = contentDiv.querySelectorAll('h2');
            const ornaments = ['✦', '❦', '✧', '◈', '◆', '✱', '❋', '✾'];
            
            h2Elements.forEach((h2, index) => {
                if (index > 0) { // Don't add before the first h2
                    const divider = document.createElement('div');
                    divider.className = 'divider-ornament';
                    divider.textContent = ornaments[index % ornaments.length];
                    h2.parentNode.insertBefore(divider, h2);
                }
            });

            // Also add images between major sections if we have them
            const scrollImages = {
                1: ['scroll-01-02.png', 'scroll-01-03.png', 'scroll-01-04.png'],
                2: ['scroll-02-02.png', 'scroll-02-03.png', 'scroll-02-04.png'],
                3: ['scroll-03-02.png', 'scroll-03-03.png', 'scroll-03-04.png'],
                4: ['scroll-04-02.png', 'scroll-04-03.png', 'scroll-04-04.png']
            };

            const images = scrollImages[scrollNum];
            if (images && images.length > 0) {
                const h2Count = h2Elements.length;
                const imagesToInsert = Math.min(images.length, Math.floor(h2Count / 2));
                
                for (let i = 0; i < imagesToInsert; i++) {
                    const targetIndex = Math.floor((i + 1) * (h2Count / (imagesToInsert + 1)));
                    if (h2Elements[targetIndex]) {
                        const imageDiv = document.createElement('div');
                        imageDiv.className = 'section-divider';
                        imageDiv.innerHTML = `
                            <img class="divider-image lazy" 
                                 data-src="images/${images[i]}" 
                                 alt=""
                                 role="presentation"
                                 loading="lazy">
                        `;
                        h2Elements[targetIndex].parentNode.insertBefore(imageDiv, h2Elements[targetIndex]);
                    }
                }
            }
        }

        // Setup lazy loading with Intersection Observer
        function setupLazyLoading() {
            const lazyImages = document.querySelectorAll('img.lazy');
            const dividers = document.querySelectorAll('.section-divider, .divider-ornament');
            
            // Use native lazy loading if supported
            if ('loading' in HTMLImageElement.prototype) {
                lazyImages.forEach(img => {
                    img.loading = 'lazy';
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.onload = () => {
                            img.classList.add('loaded');
                        };
                    }
                });
            } else {
                // Fallback to Intersection Observer
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                // Load image with priority based on viewport position
                                const priority = entry.intersectionRatio > 0.5 ? 'high' : 'low';
                                img.fetchPriority = priority;
                                
                                img.src = img.dataset.src;
                                img.onload = () => {
                                    img.classList.add('loaded');
                                };
                            }
                            observer.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '100px 0px', // Increased for better preloading
                    threshold: [0.01, 0.5]
                });
                
                lazyImages.forEach(img => imageObserver.observe(img));
            }

            const dividerObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                rootMargin: '0px 0px',
                threshold: 0.1
            });

            dividers.forEach(divider => dividerObserver.observe(divider));
        }

        // Add social sharing buttons
        function addSocialSharing() {
            const scrollContainer = document.querySelector('.scroll-container');
            const contentDiv = document.getElementById('scrollContent');
            
            const shareSection = document.createElement('div');
            shareSection.className = 'social-sharing';
            
            const currentUrl = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(`GitScroll ${scrollNum}: ${currentScroll.title}`);
            const text = encodeURIComponent(`Reading "${currentScroll.title}" from The GitScrolls - ancient wisdom for modern developers`);
            
            shareSection.innerHTML = `
                <h3>Share this ancient wisdom</h3>
                <div class="share-buttons" role="group" aria-label="Social media sharing options">
                    <a href="https://twitter.com/intent/tweet?url=${currentUrl}&text=${text}" 
                       class="share-button" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       aria-label="Share on Twitter (opens in new window)">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                        <span>Twitter</span>
                    </a>
                    
                    <a href="https://www.linkedin.com/sharing/share-offsite/?url=${currentUrl}" 
                       class="share-button" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       aria-label="Share on LinkedIn">
                        <svg viewBox="0 0 24 24">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                        LinkedIn
                    </a>
                    
                    <a href="https://www.facebook.com/sharer/sharer.php?u=${currentUrl}" 
                       class="share-button" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       aria-label="Share on Facebook">
                        <svg viewBox="0 0 24 24">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </a>
                    
                    <a href="mailto:?subject=${title}&body=${text}%20${currentUrl}" 
                       class="share-button"
                       aria-label="Share via Email">
                        <svg viewBox="0 0 24 24">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                        Email
                    </a>
                </div>
            `;
            
            // Insert after content but before navigation
            const navSection = document.getElementById('scrollNav');
            scrollContainer.insertBefore(shareSection, navSection);
        }

        // Update meta tags dynamically
        function updateMetaTags() {
            const description = `Read GitScroll ${scrollNum}: ${currentScroll.title} - Ancient wisdom for modern developers`;
            
            // Update description
            document.querySelector('meta[name="description"]').setAttribute('content', description);
            
            // Update Open Graph
            document.querySelector('meta[property="og:title"]').setAttribute('content', `GitScroll ${scrollNum}: ${currentScroll.title}`);
            document.querySelector('meta[property="og:description"]').setAttribute('content', description);
            document.querySelector('meta[property="og:url"]').setAttribute('content', window.location.href);
            
            // Update Twitter Card
            document.querySelector('meta[name="twitter:title"]').setAttribute('content', `GitScroll ${scrollNum}: ${currentScroll.title}`);
            document.querySelector('meta[name="twitter:description"]').setAttribute('content', description);
            document.querySelector('meta[name="twitter:url"]').setAttribute('content', window.location.href);
        }

        // Analytics tracking
        let scrollStartTime = Date.now();
        let maxScrollDepth = 0;
        let scrollMilestones = [25, 50, 75, 90, 100];
        let reachedMilestones = new Set();

        // Track scroll depth
        function trackScrollDepth() {
            const scrollTop = window.scrollY;
            const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrollPercent = Math.round((scrollTop / docHeight) * 100);
            
            if (scrollPercent > maxScrollDepth) {
                maxScrollDepth = scrollPercent;
                
                // Check milestones
                scrollMilestones.forEach(milestone => {
                    if (scrollPercent >= milestone && !reachedMilestones.has(milestone)) {
                        reachedMilestones.add(milestone);
                        trackEvent('scroll_milestone', {
                            scroll_number: scrollNum,
                            scroll_title: currentScroll.title,
                            milestone: milestone,
                            time_to_reach: Math.round((Date.now() - scrollStartTime) / 1000)
                        });
                    }
                });
            }
        }

        // Track events with Umami
        function trackEvent(eventName, eventData = {}) {
            // Umami tracking
            if (typeof umami !== 'undefined') {
                umami.track(eventName, eventData);
            }
            
            // Console logging for development
            console.log('Analytics Event:', eventName, eventData);
        }

        // Track page view with scroll info
        window.addEventListener('load', () => {
            trackEvent('scroll_view', {
                scroll_number: scrollNum,
                scroll_title: currentScroll.title
            });
        });

        // Track scroll depth
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(trackScrollDepth, 100);
        });

        // Track time on page when leaving
        window.addEventListener('beforeunload', () => {
            const timeOnPage = Math.round((Date.now() - scrollStartTime) / 1000);
            trackEvent('scroll_session', {
                scroll_number: scrollNum,
                scroll_title: currentScroll.title,
                time_on_page: timeOnPage,
                max_scroll_depth: maxScrollDepth,
                completed: maxScrollDepth >= 90
            });
        });

        // Track social shares
        document.addEventListener('click', (e) => {
            if (e.target.closest('.share-button')) {
                const button = e.target.closest('.share-button');
                const platform = button.textContent.trim();
                trackEvent('social_share', {
                    scroll_number: scrollNum,
                    scroll_title: currentScroll.title,
                    platform: platform
                });
            }
        });

        // Track navigation clicks
        document.addEventListener('click', (e) => {
            if (e.target.closest('.nav-button')) {
                const button = e.target.closest('.nav-button');
                const direction = button.textContent.includes('Previous') ? 'previous' : 'next';
                trackEvent('scroll_navigation', {
                    from_scroll: scrollNum,
                    direction: direction
                });
            }
        });

        // Performance monitoring and optimization
        window.addEventListener('load', () => {
            // Optimize scroll performance
            let scrolling = false;
            let scrollEndTimer;
            
            window.addEventListener('scroll', () => {
                if (!scrolling) {
                    scrolling = true;
                    document.body.style.pointerEvents = 'none';
                }
                
                clearTimeout(scrollEndTimer);
                scrollEndTimer = setTimeout(() => {
                    scrolling = false;
                    document.body.style.pointerEvents = 'auto';
                }, 150);
            }, { passive: true });
            
            // Track performance metrics after everything loads
            setTimeout(() => {
                if (window.performance) {
                    // Use Performance Observer API if available
                    if ('PerformanceObserver' in window) {
                        // Observe Largest Contentful Paint
                        try {
                            const lcpObserver = new PerformanceObserver((list) => {
                                const entries = list.getEntries();
                                const lastEntry = entries[entries.length - 1];
                                trackEvent('core_web_vitals', {
                                    lcp: Math.round(lastEntry.renderTime || lastEntry.loadTime),
                                    scroll_number: scrollNum
                                });
                            });
                            lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
                        } catch (e) {
                            // LCP not supported
                        }
                        
                        // Observe First Input Delay
                        try {
                            const fidObserver = new PerformanceObserver((list) => {
                                const entries = list.getEntries();
                                entries.forEach(entry => {
                                    trackEvent('core_web_vitals', {
                                        fid: Math.round(entry.processingStart - entry.startTime),
                                        scroll_number: scrollNum
                                    });
                                });
                            });
                            fidObserver.observe({ entryTypes: ['first-input'] });
                        } catch (e) {
                            // FID not supported
                        }
                    }
                    
                    // Traditional performance metrics
                    if (window.performance.timing) {
                        const timing = window.performance.timing;
                        const metrics = {
                            page_load_time: timing.loadEventEnd - timing.navigationStart,
                            dom_ready_time: timing.domContentLoadedEventEnd - timing.navigationStart,
                            first_paint: timing.responseStart - timing.navigationStart,
                            total_resources: window.performance.getEntriesByType('resource').length
                        };
                        
                        trackEvent('performance_metrics', metrics);
                    }
                    
                    // Memory usage if available
                    if (performance.memory) {
                        trackEvent('memory_usage', {
                            used_js_heap: Math.round(performance.memory.usedJSHeapSize / 1048576),
                            total_js_heap: Math.round(performance.memory.totalJSHeapSize / 1048576),
                            limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576)
                        });
                    }
                }
            }, 1000);
        });

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Theme Management
        const themeToggle = document.getElementById('themeToggle');
        
        // Get stored theme or system preference
        function getTheme() {
            const stored = localStorage.getItem('theme');
            if (stored) return stored;
            
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return 'dark';
            }
            return 'light';
        }
        
        // Apply theme
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update meta theme color
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) {
                metaTheme.content = theme === 'dark' ? '#2c2c2c' : '#f4f1e8';
            } else {
                const meta = document.createElement('meta');
                meta.name = 'theme-color';
                meta.content = theme === 'dark' ? '#2c2c2c' : '#f4f1e8';
                document.head.appendChild(meta);
            }
        }
        
        // Toggle theme
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            
            // Update aria-pressed
            themeToggle.setAttribute('aria-pressed', newTheme === 'dark');
            
            // Track theme change
            trackEvent('theme_change', {
                from: currentTheme,
                to: newTheme
            });
        });
        
        // Apply initial theme
        const initialTheme = getTheme();
        applyTheme(initialTheme);
        themeToggle.setAttribute('aria-pressed', initialTheme === 'dark');
        
        // Listen for system theme changes
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        }

        // Mobile Menu Toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const navLinks = document.getElementById('navLinks');
        
        mobileMenuToggle.addEventListener('click', () => {
            const isOpen = navLinks.classList.contains('active');
            navLinks.classList.toggle('active');
            mobileMenuToggle.classList.toggle('active');
            mobileMenuToggle.setAttribute('aria-expanded', !isOpen);
            
            // Track menu toggle
            trackEvent('mobile_menu_toggle', {
                action: isOpen ? 'close' : 'open'
            });
        });

        // Close mobile menu when clicking a link
        navLinks.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                navLinks.classList.remove('active');
                mobileMenuToggle.classList.remove('active');
                mobileMenuToggle.setAttribute('aria-expanded', 'false');
            });
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav-container') && navLinks.classList.contains('active')) {
                navLinks.classList.remove('active');
                mobileMenuToggle.classList.remove('active');
                mobileMenuToggle.setAttribute('aria-expanded', 'false');
            }
        });

        // Bookmarks and Highlights Implementation
        const BOOKMARKS_KEY = 'gitscrolls-bookmarks';
        const HIGHLIGHTS_KEY = `gitscrolls-highlights-${scrollNum}`;
        let bookmarks = JSON.parse(localStorage.getItem(BOOKMARKS_KEY) || '[]');
        let highlights = JSON.parse(localStorage.getItem(HIGHLIGHTS_KEY) || '[]');
        
        const bookmarkButton = document.getElementById('bookmarkButton');
        const bookmarksPanel = document.getElementById('bookmarksPanel');
        const closeBookmarksBtn = document.getElementById('closeBookmarks');
        const bookmarksList = document.getElementById('bookmarksList');
        const highlightTooltip = document.getElementById('highlightTooltip');
        
        // Update bookmark button state
        function updateBookmarkButton() {
            const currentBookmarks = bookmarks.filter(b => b.scrollNumber === scrollNum);
            if (currentBookmarks.length > 0) {
                bookmarkButton.classList.add('active');
            } else {
                bookmarkButton.classList.remove('active');
            }
        }
        
        // Toggle bookmarks panel
        bookmarkButton.addEventListener('click', () => {
            bookmarksPanel.classList.toggle('show');
            displayBookmarks();
        });
        
        closeBookmarksBtn.addEventListener('click', () => {
            bookmarksPanel.classList.remove('show');
        });
        
        // Add bookmark for current section
        function addBookmark() {
            const currentSectionEl = document.getElementById(currentActiveSection);
            if (!currentSectionEl) return;
            
            const bookmark = {
                id: Date.now(),
                scrollNumber: scrollNum,
                scrollTitle: currentScroll.title,
                sectionId: currentActiveSection,
                sectionTitle: currentSectionEl.textContent,
                excerpt: getExcerpt(currentSectionEl),
                timestamp: new Date().toISOString(),
                scrollTop: window.scrollY
            };
            
            bookmarks.push(bookmark);
            localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks));
            updateBookmarkButton();
            showPositionToast('Bookmark added');
            
            // Track bookmark
            trackEvent('bookmark_added', {
                scroll_number: scrollNum,
                section: bookmark.sectionTitle
            });
        }
        
        // Get excerpt from section
        function getExcerpt(element) {
            let nextEl = element.nextElementSibling;
            let text = '';
            
            while (nextEl && !nextEl.matches('h1, h2, h3')) {
                if (nextEl.textContent) {
                    text += nextEl.textContent + ' ';
                }
                if (text.length > 150) break;
                nextEl = nextEl.nextElementSibling;
            }
            
            return text.trim().substring(0, 150) + '...';
        }
        
        // Display bookmarks
        function displayBookmarks() {
            const allBookmarks = bookmarks.sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            bookmarksList.innerHTML = '';
            
            if (allBookmarks.length === 0) {
                bookmarksList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No bookmarks yet</p>';
                return;
            }
            
            allBookmarks.forEach(bookmark => {
                const item = document.createElement('div');
                item.className = 'bookmark-item';
                
                const date = new Date(bookmark.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                item.innerHTML = `
                    <button class="delete-bookmark" data-id="${bookmark.id}" aria-label="Delete bookmark">×</button>
                    <div class="bookmark-title">Scroll ${bookmark.scrollNumber}: ${bookmark.sectionTitle}</div>
                    <div class="bookmark-excerpt">${bookmark.excerpt}</div>
                    <div class="bookmark-date">${dateStr}</div>
                `;
                
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-bookmark')) {
                        // Navigate to bookmark
                        if (bookmark.scrollNumber === scrollNum) {
                            // Same scroll, just scroll to position
                            window.scrollTo({
                                top: bookmark.scrollTop,
                                behavior: 'smooth'
                            });
                            bookmarksPanel.classList.remove('show');
                        } else {
                            // Different scroll, navigate
                            window.location.href = `scroll.html?scroll=${bookmark.scrollNumber}#${bookmark.sectionId}`;
                        }
                    }
                });
                
                bookmarksList.appendChild(item);
            });
            
            // Delete bookmark handlers
            bookmarksList.querySelectorAll('.delete-bookmark').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = parseInt(btn.dataset.id);
                    bookmarks = bookmarks.filter(b => b.id !== id);
                    localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks));
                    updateBookmarkButton();
                    displayBookmarks();
                    showPositionToast('Bookmark removed');
                });
            });
        }
        
        // Text highlighting functionality
        let selectedText = '';
        let selectedRange = null;
        
        document.addEventListener('mouseup', (e) => {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            
            if (text && text.length > 3 && e.target.closest('.scroll-content')) {
                selectedText = text;
                selectedRange = selection.getRangeAt(0);
                
                // Position tooltip
                const rect = selectedRange.getBoundingClientRect();
                highlightTooltip.style.left = rect.left + (rect.width / 2) - 50 + 'px';
                highlightTooltip.style.top = rect.top - 50 + window.scrollY + 'px';
                highlightTooltip.style.display = 'block';
            } else {
                highlightTooltip.style.display = 'none';
            }
        });
        
        // Save highlight
        window.saveHighlight = function() {
            if (!selectedText || !selectedRange) return;
            
            const highlight = {
                id: Date.now(),
                text: selectedText,
                startOffset: selectedRange.startOffset,
                endOffset: selectedRange.endOffset,
                startContainer: getXPath(selectedRange.startContainer),
                endContainer: getXPath(selectedRange.endContainer),
                timestamp: new Date().toISOString()
            };
            
            highlights.push(highlight);
            localStorage.setItem(HIGHLIGHTS_KEY, JSON.stringify(highlights));
            
            // Apply highlight
            applyHighlight(selectedRange);
            
            highlightTooltip.style.display = 'none';
            window.getSelection().removeAllRanges();
            
            showPositionToast('Text highlighted');
            
            // Track highlight
            trackEvent('text_highlighted', {
                scroll_number: scrollNum,
                text_length: selectedText.length
            });
        };
        
        // Apply highlight to range
        function applyHighlight(range) {
            const span = document.createElement('span');
            span.className = 'text-highlight';
            span.setAttribute('data-highlight-id', Date.now());
            
            try {
                range.surroundContents(span);
            } catch (e) {
                // If surroundContents fails, use alternative method
                const contents = range.extractContents();
                span.appendChild(contents);
                range.insertNode(span);
            }
        }
        
        // Get XPath of element
        function getXPath(element) {
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentNode;
            }
            
            const segments = [];
            while (element && element.nodeType === Node.ELEMENT_NODE) {
                let index = 0;
                for (let sibling = element.previousSibling; sibling; sibling = sibling.previousSibling) {
                    if (sibling.nodeType === Node.ELEMENT_NODE && sibling.nodeName === element.nodeName) {
                        index++;
                    }
                }
                const tagName = element.nodeName.toLowerCase();
                const pathSegment = tagName + (index > 0 ? `[${index + 1}]` : '');
                segments.unshift(pathSegment);
                element = element.parentNode;
            }
            return segments.join('/');
        }
        
        // Restore highlights on load
        function restoreHighlights() {
            // This is a simplified version - full implementation would need to
            // reconstruct ranges from stored XPaths
            console.log(`${highlights.length} highlights to restore`);
        }
        
        // Add bookmark keyboard shortcut
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + B to bookmark current section
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                addBookmark();
            }
        });
        
        // Initialize
        updateBookmarkButton();
        setTimeout(restoreHighlights, 1000);

        // Infinite Scroll Implementation
        const infiniteScrollToggle = document.getElementById('infiniteScrollToggle');
        let infiniteScrollMode = localStorage.getItem('infiniteScrollMode') === 'true';
        let loadedScrolls = new Map(); // Track loaded scrolls
        let isLoadingNext = false;
        let isLoadingPrev = false;
        
        // Initialize infinite scroll state
        if (infiniteScrollMode) {
            enableInfiniteScroll();
        }

        infiniteScrollToggle.addEventListener('click', () => {
            infiniteScrollMode = !infiniteScrollMode;
            localStorage.setItem('infiniteScrollMode', infiniteScrollMode);
            
            if (infiniteScrollMode) {
                enableInfiniteScroll();
            } else {
                disableInfiniteScroll();
            }
        });

        function enableInfiniteScroll() {
            document.body.classList.add('infinite-mode');
            infiniteScrollToggle.classList.add('active');
            infiniteScrollToggle.querySelector('span').textContent = 'Exit Infinite';
            
            // Start monitoring scroll position
            window.addEventListener('scroll', handleInfiniteScroll);
            
            // Track current scroll in the map
            loadedScrolls.set(scrollNum, {
                element: document.querySelector('.scroll-container'),
                processed: true
            });
        }

        function disableInfiniteScroll() {
            document.body.classList.remove('infinite-mode');
            infiniteScrollToggle.classList.remove('active');
            infiniteScrollToggle.querySelector('span').textContent = 'Infinite Scroll';
            
            // Stop monitoring
            window.removeEventListener('scroll', handleInfiniteScroll);
            
            // Remove any additionally loaded scrolls
            loadedScrolls.forEach((scroll, num) => {
                if (num !== scrollNum && scroll.element) {
                    scroll.element.remove();
                }
            });
            loadedScrolls.clear();
            
            // Restore single scroll view
            location.reload();
        }

        async function handleInfiniteScroll() {
            const scrollTop = window.scrollY;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            
            // Load next scroll when near bottom
            if (scrollTop + windowHeight > documentHeight - 500 && !isLoadingNext) {
                const nextNum = Math.max(...loadedScrolls.keys()) + 1;
                if (nextNum <= 10) {
                    await loadNextScroll(nextNum);
                }
            }
            
            // Update URL based on current visible scroll
            updateVisibleScroll();
            
            // Unload scrolls that are far off screen
            cleanupOffscreenScrolls();
        }

        async function loadNextScroll(nextNum) {
            if (isLoadingNext || loadedScrolls.has(nextNum)) return;
            isLoadingNext = true;
            
            try {
                // Create container for new scroll
                const container = document.createElement('div');
                container.className = 'infinite-section loading';
                container.id = `scroll-section-${nextNum}`;
                
                // Add divider
                const divider = document.createElement('div');
                divider.className = 'scroll-divider';
                divider.innerHTML = `<span>∞ Scroll ${nextNum} ∞</span>`;
                container.appendChild(divider);
                
                // Create structure for the new scroll
                const heroSection = document.createElement('section');
                heroSection.className = 'scroll-hero';
                heroSection.innerHTML = `
                    <div class="hero-content">
                        <div class="scroll-number">SCROLL ${nextNum < 10 ? 'I'.repeat(nextNum) : 'X'}</div>
                        <h1 class="scroll-title">${scrolls[nextNum - 1].title}</h1>
                        <div class="scroll-subtitle"></div>
                        <blockquote class="hero-quote">Loading...</blockquote>
                    </div>
                `;
                
                const poemSection = document.createElement('section');
                poemSection.className = 'poem-section';
                poemSection.style.display = 'none';
                poemSection.innerHTML = `
                    <div class="poem-container">
                        <div class="poem-content"></div>
                    </div>
                `;
                
                const contentContainer = document.createElement('div');
                contentContainer.className = 'scroll-container';
                contentContainer.innerHTML = `
                    <div class="scroll-content">
                        <p>Loading scroll ${nextNum}...</p>
                    </div>
                `;
                
                container.appendChild(heroSection);
                container.appendChild(poemSection);
                container.appendChild(contentContainer);
                
                // Append to page
                document.querySelector('.footer').before(container);
                
                // Load the actual content
                const response = await fetch(`https://raw.githubusercontent.com/gitscrolls/gitscrolls/refs/heads/main/scrolls/${scrolls[nextNum - 1].file}`);
                const rawMarkdown = await response.text();
                
                // Process markdown
                const processor = new MarkdownProcessor();
                const processed = processor.process(rawMarkdown);
                
                // Update hero
                const heroImages = {
                    3: 'images/scroll-03-hero.png',
                    4: 'images/scroll-04-hero.png',
                    13: 'images/scroll-13-hero.png',
                    15: 'images/scroll-15-hero.png'
                };
                const heroImagePath = heroImages[nextNum] || `images/scroll-${String(nextNum).padStart(2, '0')}-01.png`;
                
                heroSection.style.backgroundImage = `
                    linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.3)),
                    url('${heroImagePath}')
                `;
                
                // Update content
                if (processed.subtitle) {
                    heroSection.querySelector('.scroll-subtitle').textContent = processed.subtitle;
                }
                if (processed.quote) {
                    heroSection.querySelector('.hero-quote').textContent = `"${processed.quote}"`;
                }
                
                // Update poem
                if (processed.poem) {
                    poemSection.querySelector('.poem-content').textContent = processed.poem;
                    poemSection.style.display = 'block';
                }
                
                // Render main content
                const html = marked.parse(processed.content);
                contentContainer.querySelector('.scroll-content').innerHTML = html;
                
                // Add to tracking
                loadedScrolls.set(nextNum, {
                    element: container,
                    processed: true
                });
                
                // Animate in
                setTimeout(() => {
                    container.classList.remove('loading');
                    
                    // Re-run lazy loading and section dividers for new content
                    addSectionDividersForScroll(contentContainer);
                    setupLazyLoadingForScroll(container);
                }, 100);
                
                // Track analytics
                trackEvent('infinite_scroll_load', {
                    scroll_number: nextNum,
                    scroll_title: scrolls[nextNum - 1].title
                });
                
            } catch (error) {
                console.error('Failed to load scroll:', error);
            } finally {
                isLoadingNext = false;
            }
        }

        function updateVisibleScroll() {
            const scrollTop = window.scrollY;
            const windowHeight = window.innerHeight;
            const centerY = scrollTop + windowHeight / 2;
            
            // Find which scroll is most visible
            let mostVisibleScroll = scrollNum;
            let maxVisibleHeight = 0;
            
            loadedScrolls.forEach((scroll, num) => {
                if (scroll.element) {
                    const rect = scroll.element.getBoundingClientRect();
                    const visibleHeight = Math.min(rect.bottom, windowHeight) - Math.max(rect.top, 0);
                    
                    if (visibleHeight > maxVisibleHeight) {
                        maxVisibleHeight = visibleHeight;
                        mostVisibleScroll = num;
                    }
                }
            });
            
            // Update URL without reload
            if (mostVisibleScroll !== parseInt(new URLSearchParams(window.location.search).get('scroll'))) {
                const newUrl = `${window.location.pathname}?scroll=${mostVisibleScroll}`;
                window.history.replaceState({}, '', newUrl);
                
                // Update current scroll for analytics
                const currentScrollInfo = scrolls[mostVisibleScroll - 1];
                updateMetaTagsForScroll(mostVisibleScroll, currentScrollInfo);
            }
        }

        function updateMetaTagsForScroll(num, scrollInfo) {
            const description = `Read GitScroll ${num}: ${scrollInfo.title} - Ancient wisdom for modern developers`;
            
            document.title = `The GitScrolls - ${scrollInfo.title}`;
            document.querySelector('meta[name="description"]').setAttribute('content', description);
            document.querySelector('meta[property="og:title"]').setAttribute('content', `GitScroll ${num}: ${scrollInfo.title}`);
            document.querySelector('meta[property="og:description"]').setAttribute('content', description);
            document.querySelector('meta[name="twitter:title"]').setAttribute('content', `GitScroll ${num}: ${scrollInfo.title}`);
            document.querySelector('meta[name="twitter:description"]').setAttribute('content', description);
        }

        function cleanupOffscreenScrolls() {
            const scrollTop = window.scrollY;
            const threshold = window.innerHeight * 3; // Keep 3 screens worth
            
            loadedScrolls.forEach((scroll, num) => {
                if (scroll.element) {
                    const rect = scroll.element.getBoundingClientRect();
                    const elementTop = rect.top + scrollTop;
                    
                    // Remove if too far above or below
                    if (elementTop < scrollTop - threshold || elementTop > scrollTop + threshold) {
                        if (loadedScrolls.size > 2) { // Always keep at least 2
                            scroll.element.classList.add('removing');
                            setTimeout(() => {
                                scroll.element.remove();
                                loadedScrolls.delete(num);
                            }, 600);
                        }
                    }
                }
            });
        }

        function addSectionDividersForScroll(container) {
            const h2Elements = container.querySelectorAll('h2');
            const ornaments = ['✦', '❦', '✧', '◈', '◆', '✱', '❋', '✾'];
            
            h2Elements.forEach((h2, index) => {
                if (index > 0) {
                    const divider = document.createElement('div');
                    divider.className = 'divider-ornament';
                    divider.textContent = ornaments[index % ornaments.length];
                    h2.parentNode.insertBefore(divider, h2);
                }
            });
        }

        function setupLazyLoadingForScroll(container) {
            const lazyImages = container.querySelectorAll('img.lazy');
            const dividers = container.querySelectorAll('.divider-ornament');
            
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.onload = () => {
                                img.classList.add('loaded');
                            };
                        }
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.01
            });

            lazyImages.forEach(img => imageObserver.observe(img));
        }
    </script>
</body>
</html>